<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recebimento de Nota Fiscal - GERENCIAL HS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
  <!-- libs do leitor (mantidas) -->
  <script src="https://unpkg.com/@ericblade/quagga2@1.2.7/dist/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.21/dist/dbr.js"></script>
</head>
<body>
  <a href="index.html" class="back-button show"><i class="fas fa-arrow-left"></i> Voltar √† Home</a>
  <div id="nf" class="section active">
    <div class="form-container">
      <img src="logo.png" alt="Logo" class="logo">
      
      <div id="login-nf">
        <h2>Login da Filial</h2>
        <label for="codigo-nf">C√≥digo da Filial</label>
        <input type="text" id="codigo-nf" placeholder="Digite sua senha" />
        <button id="btn-entrar-nf" onclick="entrarNF()">Entrar</button>
      </div>

      <div id="principal-nf" class="hidden">
        <div class="logout">
          <button onclick="sairNF()">Sair</button>
        </div>
        <h2>Consulta de Nota Fiscal</h2>
        <label for="chave-nf">Chave de Acesso (44 d√≠gitos)</label>
        <input type="text" id="chave-nf" placeholder="Digite a chave completa" maxlength="44" />
        <button onclick="abrirLeitorNF()">üì∑ Ler C√≥digo de Barras</button>

        <div id="scanner"></div>

        <button onclick="consultarNotaNF()">Consultar</button>
        <div id="loading-nf" class="loading hidden">‚è≥ Consultando nota fiscal...</div>
        <div id="resultado-nf" class="result hidden"></div>
        <div id="erro-nf" style="color: #d93025; margin-top: 10px; font-size: 14px;"></div>

        <div class="history">
          <h3>Hist√≥rico da Filial</h3>
          <ul id="historicoLista-nf"></ul>
          <button onclick="limparHistoricoLocalNF()">üóë Limpar Hist√≥rico Local</button>
        </div>
      </div>
    </div>
  </div>
  <footer>HS Opera√ß√µes ¬© 2025 - Todos os direitos reservados</footer>

  <!-- teu script principal: se ele quebrar, o fallback abaixo assume -->
  <script src="script.js"></script>

  <!-- Fallback defensivo: se script.js n√£o definiu as fun√ß√µes de NF, cria vers√µes locais -->
  <script>
  (function() {
    // ==== MAPA DE C√ìDIGOS -> FILIAL (usa os mesmos que voc√™ j√° tinha no script.js) ====
    // Ex.: "ARTUR": "288", "FLORIANO": "287", "JOTA": "293", ...
    var senhasNF = {
      "ARTUR": "288",
      "FLORIANO": "287",
      "JOTA": "293",
      "MODA": "294",
      "PONTO": "295"
    };

    // Se o script.js j√° definiu, respeitamos. Se n√£o, criamos.
    if (typeof window.filialLogadaNF === "undefined") window.filialLogadaNF = null;

    // Utilit√°rio
    function $(sel){ return document.querySelector(sel); }

    // ===== entrarNF (fallback) =====
    if (typeof window.entrarNF !== "function") {
      window.entrarNF = function entrarNF(){
        var codigo = ($("#codigo-nf")?.value || "").trim();
        var filial = Object.keys(senhasNF).find(function(key){ return senhasNF[key] === codigo; });

        if (filial) {
          window.filialLogadaNF = filial;
          $("#login-nf")?.classList.add("hidden");
          $("#principal-nf")?.classList.remove("hidden");
          carregarHistoricoNF(); // ok se existir, sen√£o o nosso fallback define abaixo
        } else {
          // mensagem simples no lugar de alert
          var el = $("#erro-nf");
          if (el) { el.textContent = "C√≥digo da filial incorreto."; }
        }
      };
    }

    // ===== sairNF (fallback) =====
    if (typeof window.sairNF !== "function") {
      window.sairNF = function sairNF(){
        window.filialLogadaNF = null;
        $("#principal-nf")?.classList.add("hidden");
        $("#login-nf")?.classList.remove("hidden");
        var el = $("#codigo-nf"); if (el) el.value = "";
        $("#erro-nf")?.textContent = "";
        $("#resultado-nf")?.classList.add("hidden");
        $("#resultado-nf")?.innerHTML = "";
      };
    }

    // ===== carregarHistoricoNF (fallback) =====
    if (typeof window.carregarHistoricoNF !== "function") {
      window.carregarHistoricoNF = function carregarHistoricoNF(){
        if (!window.filialLogadaNF) return;
        var historico = [];
        try {
          historico = JSON.parse(localStorage.getItem("historicoNF_" + window.filialLogadaNF)) || [];
        } catch(_) {}
        var lista = $("#historicoLista-nf");
        if (!lista) return;
        lista.innerHTML = "";
        historico.forEach(function(item){
          var li = document.createElement("li");
          try {
            var dt = new Date(item.data).toLocaleString();
            li.textContent = dt + " - " + (item.nomeEmitente || "") + " (" + (item.chave || "").substring(0,6) + "...)";
          } catch(_) {
            li.textContent = (item.chave || "");
          }
          li.onclick = function(){
            var inp = $("#chave-nf"); if (inp) inp.value = item.chave || "";
            if (typeof window.consultarNotaNF === "function") window.consultarNotaNF();
          };
          lista.appendChild(li);
        });
      };
    }

    // ===== limparHistoricoLocalNF (fallback) =====
    if (typeof window.limparHistoricoLocalNF !== "function") {
      window.limparHistoricoLocalNF = function limparHistoricoLocalNF(){
        if (!window.filialLogadaNF) return;
        try {
          localStorage.removeItem("historicoNF_" + window.filialLogadaNF);
        } catch(_) {}
        window.carregarHistoricoNF();
      };
    }

    // ===== abrirLeitorNF (fallback m√≠nimo) =====
    if (typeof window.abrirLeitorNF !== "function") {
      window.abrirLeitorNF = async function abrirLeitorNF(){
        // Se voc√™ j√° usa Dynamsoft no script.js, √≥timo. Aqui s√≥ garantimos que n√£o quebre.
        if (!window.Dynamsoft || !Dynamsoft.DBR || !Dynamsoft.DBR.BarcodeScanner) {
          var el = $("#erro-nf");
          if (el) el.textContent = "Leitor indispon√≠vel nesta p√°gina.";
          return;
        }
        try {
          var scanner = await Dynamsoft.DBR.BarcodeScanner.createInstance();
          var host = $("#scanner");
          if (host) host.appendChild(scanner.getUIElement());
          scanner.onFrameRead = function(results){
            if (results && results.length) {
              var code = results[0].barcodeText || "";
              var inp = $("#chave-nf"); if (inp) inp.value = code;
              scanner.hide();
              host && (host.style.display = "none");
              if (typeof window.consultarNotaNF === "function") window.consultarNotaNF();
            }
          };
          await scanner.show();
          if (host) host.style.display = "block";
        } catch (ex) {
          var el = $("#erro-nf");
          if (el) el.textContent = ex && ex.message ? ex.message : "Erro ao abrir leitor.";
        }
      };
    }

    // ===== consultarNotaNF (placeholder opcional) =====
    // (Se j√° existir no seu script.js, a sua vers√£o √© usada.)
    if (typeof window.consultarNotaNF !== "function") {
      window.consultarNotaNF = function consultarNotaNF(){
        var chave = ($("#chave-nf")?.value || "").replace(/\D+/g,"");
        var erro = $("#erro-nf"), res = $("#resultado-nf");
        if (erro) erro.textContent = "";
        if (res) { res.classList.add("hidden"); res.innerHTML = ""; }

        if (chave.length !== 44) {
          if (erro) erro.textContent = "A chave deve ter 44 d√≠gitos.";
          return;
        }
        // Aqui voc√™ j√° tinha a chamada √† API externa no script.js.
        // Este fallback s√≥ valida a chave e n√£o consulta a API.
        if (res) {
          res.innerHTML = "<p>Chave v√°lida. (A consulta real permanece no seu script.js)</p>";
          res.classList.remove("hidden");
        }
      };
    }

    // ===== UX: Enter no campo de c√≥digo chama entrarNF =====
    document.addEventListener("DOMContentLoaded", function(){
      var input = $("#codigo-nf");
      var btn   = $("#btn-entrar-nf");
      if (input) {
        input.addEventListener("keydown", function(ev){
          if (ev.key === "Enter") {
            ev.preventDefault();
            if (typeof window.entrarNF === "function") window.entrarNF();
          }
        });
      }
      // Se j√° havia filial logada (persistida em outro script), respeitamos
      // (Opcional: voc√™ pode guardar a filial em localStorage ao logar)
    });
  })();
  </script>
</body>
</html>
