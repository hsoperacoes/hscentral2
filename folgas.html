<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro de Folgas - GERENCIAL HS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Botão padrão para voltar à home -->
  <a href="index.html" class="back-button show">
    <i class="fas fa-arrow-left"></i> Voltar à Home
  </a>

  <div id="folgas" class="section active">
    <div class="form-container">
      <img src="logo.png" alt="Logo" class="logo">
      <h2>Cadastro de Folga Funcionários</h2>

      <form id="form-folgas" method="POST"
            action="https://script.google.com/macros/s/AKfycbwh-YUwL2o3_i-bfcV9RMzLcoI98vyyGwEXf4LHlG5KJ59gIAlUe1_VVlFQMBqU6PwR/exec">
        <!-- FILIAL -->
        <div class="form-group">
          <label for="filial-folgas">Filial</label>
          <select id="filial-folgas" name="filial" required>
            <option value="">Selecione uma filial</option>
            <option value="ARTUR">ARTUR</option>
            <option value="FLORIANO">FLORIANO</option>
            <option value="JOTA">JOTA</option>
            <option value="MODA">MODA</option>
            <option value="PONTO">PONTO</option>
          </select>
        </div>

        <!-- FUNCIONÁRIO (carregado da aba FUNCIONÁRIOS via script.js) -->
        <div class="form-group">
          <label for="funcionario-folgas">Funcionário</label>
          <select id="funcionario-folgas" name="funcionario" required>
            <option value="">Carregando lista de funcionários...</option>
          </select>
        </div>

        <!-- DIA TRABALHADO -->
        <div class="form-group">
          <label for="dataTrabalho-folgas">Dia Trabalhado</label>
          <input type="date" id="dataTrabalho-folgas" name="dataTrabalho" required>
        </div>

        <!-- MOTIVO -->
        <div class="form-group">
          <label for="motivo-folgas">Motivo da Folga</label>
          <select id="motivo-folgas" name="motivo" required>
            <option value="">Selecione um motivo</option>
            <option value="DOMINGO">DOMINGO</option>
            <option value="FERIADO">FERIADO</option>
            <option value="OUTROS">OUTROS</option>
          </select>
        </div>

        <!-- MOTIVO OUTROS -->
        <div class="form-group" id="motivoOutros-folgas" style="display: none;">
          <label for="outrosMotivo-folgas">Especificar o Motivo</label>
          <input
            type="text"
            id="outrosMotivo-folgas"
            name="outrosMotivo"
            placeholder="Escreva o motivo">
        </div>

        <!-- DATA DA FOLGA -->
        <div class="form-group">
          <label for="dataFolga-folgas">Data da Folga</label>
          <input type="date" id="dataFolga-folgas" name="dataFolga" required>
        </div>

        <button type="submit">Enviar</button>
      </form>
    </div>
  </div>

  <footer>HS Operações © 2025 - Todos os direitos reservados</footer>

  <!-- STUB da Dynamsoft para evitar erro se o script.js mexer no leitor -->
  <script>
    window.Dynamsoft = window.Dynamsoft || {};
    Dynamsoft.DBR = Dynamsoft.DBR || {};
    Dynamsoft.DBR.BarcodeScanner = Dynamsoft.DBR.BarcodeScanner || {};
  </script>

  <!-- Seu JS global (onde já está a parte que busca FUNCIONÁRIOS e monta window.funcionariosPorFilial) -->
  <script src="./script.js"></script>

  <!-- Lógica específica da página de FOLGAS -->
  <script>
    (function () {
      const filialSel   = document.getElementById('filial-folgas');
      const funcSel     = document.getElementById('funcionario-folgas');
      const motivoSel   = document.getElementById('motivo-folgas');
      const dataTrabInp = document.getElementById('dataTrabalho-folgas');
      const dataFolgaInp= document.getElementById('dataFolga-folgas');
      const motivoOutrosDiv = document.getElementById('motivoOutros-folgas');
      const outrosMotivoInp = document.getElementById('outrosMotivo-folgas');
      const formFolgas  = document.getElementById('form-folgas');

      // --- CARREGAR FUNCIONÁRIOS A PARTIR DO MESMO SCRIPT DA RESERVA ---
      function preencherSelectCarregando() {
        if (!funcSel) return;
        funcSel.innerHTML = '<option value="">Carregando funcionários...</option>';
      }

      function atualizarFuncionariosFolgas() {
        if (!filialSel || !funcSel) return;

        const mapa = (window.funcionariosPorFilial || {});
        const filial = (filialSel.value || '').trim();

        funcSel.innerHTML = '<option value="">Selecione um funcionário</option>';

        if (mapa[filial] && Array.isArray(mapa[filial])) {
          mapa[filial].forEach(function (nome) {
            const opt = document.createElement('option');
            opt.value = nome;
            opt.textContent = nome;
            funcSel.appendChild(opt);
          });
        }
      }

      async function inicializarFuncionarios() {
        try {
          if (!funcSel) return;
          preencherSelectCarregando();

          // Se existir uma função global carregarFuncionarios() (definida no script.js), usa ela
          if (typeof window.carregarFuncionarios === 'function') {
            await window.carregarFuncionarios();
          }

          // Liga o change depois que carregou o mapa
          if (filialSel) {
            filialSel.addEventListener('change', atualizarFuncionariosFolgas);

            // Se a filial já vier preenchida (futuro login por filial), já popula
            if (filialSel.value) {
              atualizarFuncionariosFolgas();
            } else {
              funcSel.innerHTML = '<option value="">Selecione um funcionário</option>';
            }
          }
        } catch (err) {
          console.error('Erro ao carregar funcionários:', err);
          funcSel.innerHTML = '<option value="">Erro ao carregar funcionários</option>';
        }
      }

      // --- REGRAS DE MOTIVO / DATAS (igual à versão funcional antiga) ---
      function verificarMotivo() {
        const motivo = motivoSel.value;

        if (!dataTrabInp.value) {
          alert("Selecione primeiro o 'Dia Trabalhado'!");
          motivoSel.value = '';
          return;
        }

        const dataTrabalho = new Date(dataTrabInp.value + 'T00:00:00');
        const maxDate = new Date(dataTrabalho);

        if (motivo === "DOMINGO") {
          maxDate.setDate(dataTrabalho.getDate() + 7);
        } else if (motivo === "FERIADO" || motivo === "OUTROS") {
          maxDate.setDate(dataTrabalho.getDate() + 60);
        }

        dataFolgaInp.min = dataTrabalho.toISOString().split('T')[0];
        dataFolgaInp.max = maxDate.toISOString().split('T')[0];

        // Campo "OUTROS"
        motivoOutrosDiv.style.display = motivo === "OUTROS" ? "block" : "none";
        outrosMotivoInp.required = (motivo === "OUTROS");
      }

      if (dataTrabInp && motivoSel) {
        dataTrabInp.addEventListener('change', function () {
          if (motivoSel.value !== '') {
            verificarMotivo();
          }
        });
        motivoSel.addEventListener('change', verificarMotivo);
      }

      // --- ENVIO DO FORMULÁRIO (mesmo esquema que já funciona: fetch + reset + alert) ---
      if (formFolgas) {
        formFolgas.addEventListener('submit', function (event) {
          event.preventDefault();
          const form = this;
          const formData = new FormData(form);

          fetch(form.action, {
            method: "POST",
            body: formData
          })
          .then(response => response.text())
          .then(() => {
            alert("Folga cadastrada com sucesso!");
            form.reset();
            // volta o select de funcionários pro estado inicial
            if (funcSel) {
              funcSel.innerHTML = '<option value="">Selecione um funcionário</option>';
            }
            motivoOutrosDiv.style.display = "none";
          })
          .catch(() => {
            alert("Erro ao enviar os dados!");
          });
        });
      }

      // Inicializa tudo quando o DOM estiver pronto
      document.addEventListener('DOMContentLoaded', inicializarFuncionarios);
      // Também chama direto (por segurança, caso o script carregue depois do DOM)
      inicializarFuncionarios();
    })();
  </script>
</body>
</html>
